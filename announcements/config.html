<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é€šå‘Šé…ç½®å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        padding: 40px;
        max-width: 700px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }

      input[type="text"],
      input[type="number"],
      input[type="datetime-local"],
      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      input[type="datetime-local"]:focus,
      select:focus {
        outline: none;
        border-color: #00b4ff;
      }

      input[type="checkbox"] {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        cursor: pointer;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
      }

      .hint {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }

      .strategy-desc {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        padding: 8px;
        background: #f5f5f5;
        border-radius: 4px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 30px;
      }

      button {
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-primary {
        background: linear-gradient(135deg, #00b4ff 0%, #0096d4 100%);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 180, 255, 0.4);
      }

      .btn-secondary {
        background: #f0f0f0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
      }

      .message {
        margin-top: 20px;
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
        display: none;
      }

      .message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }

      .message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }

      .info-box {
        background: #e7f3ff;
        border-left: 4px solid #00b4ff;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 4px;
      }

      .info-box p {
        margin: 5px 0;
        font-size: 13px;
        color: #333;
      }

      .info-box strong {
        color: #00b4ff;
      }

      .time-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      @media (max-width: 600px) {
        .time-group {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“¢ é€šå‘Šé…ç½®å·¥å…·</h1>
      <p class="subtitle">å‘å¸ƒè€…ä¸“ç”¨ - ç¼–è¾‘é€šå‘Šé…ç½®æ–‡ä»¶</p>

      <div class="info-box">
        <p><strong>ä½¿ç”¨è¯´æ˜ï¼š</strong></p>
        <p>
          1. ç‚¹å‡»"åŠ è½½é…ç½®æ–‡ä»¶"æŒ‰é’®ï¼Œé€‰æ‹© public/announcements/config.json æ–‡ä»¶
        </p>
        <p>2. ä¿®æ”¹é…ç½®ä¿¡æ¯</p>
        <p>3. ç‚¹å‡»"ä¿å­˜é…ç½®æ–‡ä»¶"æŒ‰é’®ä¸‹è½½ä¿®æ”¹åçš„é…ç½®æ–‡ä»¶</p>
        <p>
          4. å°†ä¸‹è½½çš„ config.json æ–‡ä»¶æ›¿æ¢ public/announcements/ ç›®å½•ä¸‹çš„åŸæ–‡ä»¶
        </p>
        <p>5. é‡æ–°æ„å»ºå¹¶å‘å¸ƒåº”ç”¨</p>
      </div>

      <form id="configForm">
        <!-- å¯ç”¨/ç¦ç”¨ -->
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="enabled" name="enabled" checked />
            <label for="enabled">å¯ç”¨é€šå‘ŠåŠŸèƒ½</label>
          </div>
        </div>

        <!-- æ–‡ä»¶å -->
        <div class="form-group">
          <label for="filename">é€šå‘Šæ–‡ä»¶å *</label>
          <input
            type="text"
            id="filename"
            name="filename"
            value="announcement.html"
            required
            placeholder="announcement.html"
          />
          <div class="hint">æ–‡ä»¶åº”ä½äº public/announcements/ ç›®å½•ä¸‹</div>
        </div>

        <!-- å¼¹å‡ºç­–ç•¥ -->
        <div class="form-group">
          <label for="strategy">å¼¹å‡ºç­–ç•¥ *</label>
          <select id="strategy" name="strategy" required>
            <option value="once_per_day">å½“å¤©ä»…å¼¹å‡ºä¸€æ¬¡</option>
            <option value="every_launch">æ¯æ¬¡æ‰“å¼€ç¨‹åºå¼¹å‡ºä¸€æ¬¡</option>
            <option value="interval_minutes">é—´éš”XXåˆ†é’Ÿå¼¹å‡ºä¸€æ¬¡</option>
          </select>
          <div class="strategy-desc" id="strategyDesc">
            æ¯å¤©ç¬¬ä¸€æ¬¡æ‰“å¼€åº”ç”¨æ—¶å¼¹å‡ºï¼ŒåŒä¸€å¤©å†…ä¸ä¼šé‡å¤å¼¹å‡º
          </div>
        </div>

        <!-- é—´éš”æ—¶é—´ -->
        <div class="form-group" id="intervalGroup" style="display: none">
          <label for="intervalMinutes">é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ *</label>
          <input
            type="number"
            id="intervalMinutes"
            name="intervalMinutes"
            value="60"
            min="1"
            required
          />
          <div class="hint">è®¾ç½®ä¸¤æ¬¡å¼¹å‡ºä¹‹é—´çš„é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</div>
        </div>

        <!-- ç”Ÿæ•ˆæ—¶é—´ -->
        <div class="form-group">
          <label>ç”Ÿæ•ˆæ—¶é—´ï¼ˆå¯é€‰ï¼Œä»…é’ˆå¯¹æœ¬æ¬¡å…¬å‘Šï¼‰</label>
          <div class="time-group">
            <div>
              <label for="startTime" style="font-size: 12px; color: #666">
                å¼€å§‹æ—¶é—´
              </label>
              <input type="datetime-local" id="startTime" name="startTime" />
              <div class="hint">ç•™ç©ºè¡¨ç¤ºç«‹å³ç”Ÿæ•ˆ</div>
            </div>
            <div>
              <label for="endTime" style="font-size: 12px; color: #666">
                ç»“æŸæ—¶é—´
              </label>
              <input type="datetime-local" id="endTime" name="endTime" />
              <div class="hint">ç•™ç©ºè¡¨ç¤ºæ°¸ä¹…ç”Ÿæ•ˆ</div>
            </div>
          </div>
        </div>

        <!-- æŒ‰é’®ç»„ -->
        <div class="button-group">
          <button type="button" class="btn-primary" id="saveBtn">
            ä¿å­˜é…ç½®æ–‡ä»¶
          </button>
          <button type="button" class="btn-secondary" id="loadBtn">
            åŠ è½½é…ç½®æ–‡ä»¶
          </button>
        </div>
        <div class="button-group" style="margin-top: 10px">
          <button
            type="button"
            class="btn-secondary"
            id="directSaveBtn"
            style="display: none"
          >
            ç›´æ¥ä¿å­˜åˆ°æ–‡ä»¶
          </button>
        </div>

        <!-- æ¶ˆæ¯æç¤º -->
        <div class="message" id="message"></div>
      </form>
    </div>

    <script>
      const form = document.getElementById("configForm");
      const strategySelect = document.getElementById("strategy");
      const intervalGroup = document.getElementById("intervalGroup");
      const intervalInput = document.getElementById("intervalMinutes");
      const strategyDesc = document.getElementById("strategyDesc");
      const saveBtn = document.getElementById("saveBtn");
      const loadBtn = document.getElementById("loadBtn");
      const directSaveBtn = document.getElementById("directSaveBtn");
      const messageDiv = document.getElementById("message");
      const startTimeInput = document.getElementById("startTime");
      const endTimeInput = document.getElementById("endTime");

      let fileHandle = null; // ä¿å­˜æ–‡ä»¶å¥æŸ„

      // è·å–é…ç½®å¯¹è±¡
      function getConfigFromForm() {
        const formData = new FormData(form);
        const config = {
          filename: formData.get("filename") || "announcement.html",
          strategy: formData.get("strategy") || "once_per_day",
          enabled: formData.get("enabled") === "on",
        };

        // æ·»åŠ é—´éš”æ—¶é—´ï¼ˆå¦‚æœç­–ç•¥æ˜¯ interval_minutesï¼‰
        if (config.strategy === "interval_minutes") {
          const interval = parseInt(
            formData.get("intervalMinutes") || "60",
            10
          );
          if (interval > 0) {
            config.intervalMinutes = interval;
          }
        }

        // æ·»åŠ ç”Ÿæ•ˆæ—¶é—´
        const startTime = formData.get("startTime");
        const endTime = formData.get("endTime");
        if (startTime) {
          config.startTime = localToISO(startTime);
        }
        if (endTime) {
          config.endTime = localToISO(endTime);
        }

        return config;
      }

      // éªŒè¯é…ç½®
      function validateConfig(config) {
        if (!config.filename) {
          showMessage("è¯·è¾“å…¥é€šå‘Šæ–‡ä»¶å", "error");
          return false;
        }

        if (!config.strategy) {
          showMessage("è¯·é€‰æ‹©å¼¹å‡ºç­–ç•¥", "error");
          return false;
        }

        if (
          config.strategy === "interval_minutes" &&
          (!config.intervalMinutes || config.intervalMinutes < 1)
        ) {
          showMessage("é—´éš”æ—¶é—´å¿…é¡»å¤§äº0", "error");
          return false;
        }

        // éªŒè¯æ—¶é—´èŒƒå›´
        if (config.startTime && config.endTime) {
          const start = new Date(config.startTime).getTime();
          const end = new Date(config.endTime).getTime();
          if (start >= end) {
            showMessage("å¼€å§‹æ—¶é—´å¿…é¡»æ—©äºç»“æŸæ—¶é—´", "error");
            return false;
          }
        }

        return true;
      }

      // æ£€æŸ¥æ˜¯å¦æ”¯æŒ File System Access API
      if (window.showSaveFilePicker) {
        directSaveBtn.style.display = "block";

        // ç»‘å®šç›´æ¥ä¿å­˜äº‹ä»¶
        directSaveBtn.addEventListener("click", async function () {
          const config = getConfigFromForm();
          if (!validateConfig(config)) {
            return;
          }

          try {
            // å¦‚æœæ²¡æœ‰æ–‡ä»¶å¥æŸ„ï¼Œå…ˆé€‰æ‹©æ–‡ä»¶
            if (!fileHandle) {
              fileHandle = await window.showSaveFilePicker({
                suggestedName: "config.json",
                types: [
                  {
                    description: "JSON é…ç½®æ–‡ä»¶",
                    accept: {
                      "application/json": [".json"],
                    },
                  },
                ],
              });
            }

            // å†™å…¥æ–‡ä»¶
            const jsonContent = JSON.stringify(config, null, 2);
            const writable = await fileHandle.createWritable();
            await writable.write(jsonContent);
            await writable.close();

            showMessage("é…ç½®æ–‡ä»¶å·²ç›´æ¥ä¿å­˜ï¼", "success");
          } catch (error) {
            if (error.name === "AbortError") {
              // ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ
              return;
            }
            console.error("ä¿å­˜æ–‡ä»¶å¤±è´¥:", error);
            showMessage("ä¿å­˜å¤±è´¥ï¼š" + error.message, "error");
          }
        });
      }

      // ç­–ç•¥æè¿°
      const strategyDescriptions = {
        once_per_day: "æ¯å¤©ç¬¬ä¸€æ¬¡æ‰“å¼€åº”ç”¨æ—¶å¼¹å‡ºï¼ŒåŒä¸€å¤©å†…ä¸ä¼šé‡å¤å¼¹å‡º",
        every_launch:
          "æ¯æ¬¡æ‰“å¼€åº”ç”¨ï¼ˆæ–°æ ‡ç­¾é¡µ/æ–°ä¼šè¯ï¼‰æ—¶å¼¹å‡ºï¼Œåˆ·æ–°é¡µé¢ä¸ä¼šé‡å¤å¼¹å‡º",
        interval_minutes: "æ ¹æ®è®¾ç½®çš„é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰å¼¹å‡ºï¼Œé»˜è®¤é—´éš”ä¸º 60 åˆ†é’Ÿ",
      };

      // ç›‘å¬ç­–ç•¥å˜åŒ–
      strategySelect.addEventListener("change", function () {
        const strategy = this.value;
        strategyDesc.textContent = strategyDescriptions[strategy] || "";

        // æ˜¾ç¤º/éšè—é—´éš”æ—¶é—´è¾“å…¥
        if (strategy === "interval_minutes") {
          intervalGroup.style.display = "block";
          intervalInput.required = true;
        } else {
          intervalGroup.style.display = "none";
          intervalInput.required = false;
        }
      });

      // å°†æœ¬åœ°æ—¶é—´è½¬æ¢ä¸º ISO 8601 æ ¼å¼
      function localToISO(localDateTime) {
        if (!localDateTime) return undefined;
        // datetime-local æ ¼å¼: "2024-01-01T12:00"
        // è½¬æ¢ä¸º ISO 8601: "2024-01-01T12:00:00.000Z"
        const date = new Date(localDateTime);
        return date.toISOString();
      }

      // å°† ISO 8601 æ ¼å¼è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´ï¼ˆç”¨äº datetime-localï¼‰
      function isoToLocal(isoString) {
        if (!isoString) return "";
        const date = new Date(isoString);
        // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´ï¼Œæ ¼å¼: "YYYY-MM-DDTHH:mm"
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        return `${year}-${month}-${day}T${hours}:${minutes}`;
      }

      // ä¿å­˜é…ç½®æ–‡ä»¶ï¼ˆä¸‹è½½æ–¹å¼ï¼‰
      saveBtn.addEventListener("click", function () {
        const config = getConfigFromForm();
        if (!validateConfig(config)) {
          return;
        }

        // ç”ŸæˆJSONæ–‡ä»¶å†…å®¹
        const jsonContent = JSON.stringify(config, null, 2);
        const blob = new Blob([jsonContent], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "config.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showMessage(
          "é…ç½®æ–‡ä»¶å·²ç”Ÿæˆï¼è¯·å°† config.json æ›¿æ¢ public/announcements/ ç›®å½•ä¸‹çš„åŸæ–‡ä»¶",
          "success"
        );
      });

      // å¡«å……è¡¨å•æ•°æ®
      function fillFormFromConfig(config) {
        document.getElementById("enabled").checked = config.enabled !== false;
        document.getElementById("filename").value =
          config.filename || "announcement.html";
        document.getElementById("strategy").value =
          config.strategy || "once_per_day";
        document.getElementById("intervalMinutes").value =
          config.intervalMinutes || 60;

        // å¡«å……ç”Ÿæ•ˆæ—¶é—´
        if (config.startTime) {
          startTimeInput.value = isoToLocal(config.startTime);
        } else {
          startTimeInput.value = "";
        }
        if (config.endTime) {
          endTimeInput.value = isoToLocal(config.endTime);
        } else {
          endTimeInput.value = "";
        }

        // è§¦å‘ç­–ç•¥å˜åŒ–äº‹ä»¶
        strategySelect.dispatchEvent(new Event("change"));
      }

      // åŠ è½½ç°æœ‰é…ç½®ï¼ˆä¼ ç»Ÿæ–‡ä»¶é€‰æ‹©æ–¹å¼ï¼‰
      loadBtn.addEventListener("click", function () {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = function (e) {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (event) {
            try {
              const config = JSON.parse(event.target.result);
              fillFormFromConfig(config);
              showMessage("é…ç½®åŠ è½½æˆåŠŸï¼", "success");
            } catch (error) {
              showMessage("é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š" + error.message, "error");
            }
          };
          reader.readAsText(file);
        };
        input.click();
      });

      // ä½¿ç”¨ File System Access API æ‰“å¼€æ–‡ä»¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
      if (window.showOpenFilePicker) {
        // æ·»åŠ "æ‰“å¼€æ–‡ä»¶"æŒ‰é’®
        const openFileBtn = document.createElement("button");
        openFileBtn.type = "button";
        openFileBtn.className = "btn-secondary";
        openFileBtn.textContent = "æ‰“å¼€æ–‡ä»¶";
        openFileBtn.style.marginTop = "10px";
        openFileBtn.style.width = "100%";
        loadBtn.parentElement.appendChild(openFileBtn);

        openFileBtn.addEventListener("click", async function () {
          try {
            const [fileHandle] = await window.showOpenFilePicker({
              types: [
                {
                  description: "JSON é…ç½®æ–‡ä»¶",
                  accept: {
                    "application/json": [".json"],
                  },
                },
              ],
            });

            const file = await fileHandle.getFile();
            const text = await file.text();
            const config = JSON.parse(text);

            fillFormFromConfig(config);
            fileHandle = fileHandle; // ä¿å­˜æ–‡ä»¶å¥æŸ„ï¼Œä»¥ä¾¿åç»­ç›´æ¥ä¿å­˜

            showMessage("æ–‡ä»¶å·²æ‰“å¼€ï¼Œå¯ä»¥ç›´æ¥ä¿å­˜ä¿®æ”¹ï¼", "success");
          } catch (error) {
            if (error.name !== "AbortError") {
              console.error("æ‰“å¼€æ–‡ä»¶å¤±è´¥:", error);
              showMessage("æ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼š" + error.message, "error");
            }
          }
        });
      }

      // é¡µé¢åŠ è½½æ—¶å°è¯•è‡ªåŠ¨åŠ è½½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœé€šè¿‡ HTTP æœåŠ¡å™¨è®¿é—®ï¼‰
      window.addEventListener("load", function () {
        // å°è¯•ä»ç›¸å¯¹è·¯å¾„åŠ è½½é…ç½®æ–‡ä»¶
        fetch("./config.json")
          .then((response) => {
            if (response.ok) {
              return response.json();
            }
            throw new Error("é…ç½®æ–‡ä»¶ä¸å­˜åœ¨");
          })
          .then((config) => {
            fillFormFromConfig(config);
            showMessage("å·²è‡ªåŠ¨åŠ è½½é…ç½®æ–‡ä»¶", "success");
          })
          .catch(() => {
            // é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
            console.log("æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®");
          });
      });
    </script>
  </body>
</html>
