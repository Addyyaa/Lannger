# 工单 TICKET-007

**创建时间**：2024-12-19 18:00  
**创建者**：高级架构师  
**分配给**：编程专家  
**状态**：待处理  
**优先级**：P2

## 工单描述

实现 reviewLogs 数据归档策略，解决日志表持续增长导致的性能问题，采用分层归档方案（90 天内完整保留，90-365 天聚合统计）。

## 产品价值分析

### 用户是谁？TA 真正痛苦的是什么？

**目标用户**：

- 长期使用用户：学习超过 90 天的用户
- 高频学习用户：每天学习产生大量日志

**用户痛点**：

- **无直接感知**：用户不直接感知此问题
- **间接影响**：数据库变大导致应用启动变慢、查询变慢
- **数据丢失风险**：如果不清除，可能导致 IndexedDB 存储超限

### 市场天花板与付费意愿

- **市场天花板**：中等（影响约 20-30% 的长期用户）
- **付费意愿**：无（用户不关心技术优化，但会抱怨性能问题）
- **商业价值**：技术债务清理，防止未来性能问题

### MVP 边界

**核心功能**：

1. 自动归档任务：定期检查并归档过期日志
2. 90 天内：完整保留所有日志记录
3. 90-365 天：按天聚合统计（保留每日汇总数据）
4. 365 天以上：删除或归档到独立存储

**非 MVP 功能**（后续迭代）：

- 用户可配置归档策略
- 归档数据导出功能
- 可视化归档统计

### 北极星指标

- **7 天验证指标**：
  - reviewLogs 表大小：减少 50-70%
  - 查询性能：提升 20-30%
  - 归档任务执行时间：< 5 秒（后台执行）

### 竞品分析

- **Anki**：使用 SQLite，有数据清理机制
- **Quizlet**：云端存储，无此问题
- **我们的策略**：分层归档，平衡性能和数据分析需求

## 详细需求

### 功能要求

1. **归档策略定义**

   - **0-90 天**：完整保留所有 reviewLogs 记录
   - **90-365 天**：按天聚合，保留每日统计：
     - 日期
     - 单词 ID 列表（可选，如果数据量大则只保留数量）
     - 总记录数
     - 正确/错误/跳过数量
     - 平均响应时间
   - **365 天以上**：删除或移动到归档表（可选）

2. **归档任务实现**

   - 创建 `archiveReviewLogs()` 函数
   - 定期执行（建议：每天一次，或应用启动时检查）
   - 只处理超过 90 天的记录
   - 使用事务确保数据一致性

3. **聚合数据存储**

   - 创建新表 `reviewLogsArchive`（需要在 `db.ts` 中添加）
   - 数据库 Schema 定义：
     ```typescript
     // 在 db.ts 的 version(7) 中添加
     reviewLogsArchive: "++id, date, [date+wordId]";
     ```
   - 聚合数据结构：
     ```typescript
     interface ReviewLogsArchive {
       id?: number;
       date: string; // YYYY-MM-DD
       wordIds: number[]; // 或只保留数量
       totalCount: number;
       correctCount: number;
       wrongCount: number;
       skipCount: number;
       avgResponseTime?: number;
       createdAt: string;
     }
     ```

4. **归档执行逻辑**

   - 查询 90-365 天的 reviewLogs
   - 按日期分组聚合
   - 插入聚合数据到归档表
   - 删除原始 reviewLogs 记录
   - 记录归档日志（归档了多少条记录）

5. **性能优化**
   - 使用批量操作（bulkPut/bulkDelete）
   - 分批处理，避免一次性处理大量数据
   - 后台执行，不阻塞主线程

### 技术实现要点

1. **归档函数设计**

   ```typescript
   async function archiveReviewLogs(): Promise<ArchiveResult> {
     // 1. 计算归档时间范围
     // 2. 查询需要归档的记录
     // 3. 按日期聚合
     // 4. 批量插入归档数据
     // 5. 批量删除原始记录
     // 6. 返回归档统计
   }
   ```

2. **定时执行机制**

   - **执行时机**：
     - 应用启动时检查（距离上次归档 > 24 小时）
     - 使用 Web Worker 后台执行，避免阻塞主线程
     - 避免在用户操作时执行（检测用户活动状态）
   - **执行频率**：每天最多执行一次
   - **执行条件**：
     - 检查 reviewLogs 表记录数（> 1000 条才执行归档）
     - 检查是否有超过 90 天的记录

3. **数据完整性**
   - 使用事务确保原子性
   - 归档失败时回滚
   - 记录归档日志，便于排查问题

## 验收标准

- [ ] 归档函数正确识别 90-365 天的记录
- [ ] 聚合逻辑正确计算每日统计
- [ ] 归档数据正确存储到归档表
- [ ] 原始 reviewLogs 记录正确删除
- [ ] 归档任务执行时间 < 5 秒（1 万条记录）
- [ ] 归档后 reviewLogs 表大小减少 50%+
- [ ] 查询性能提升 20%+
- [ ] 归档过程不影响用户正常使用
- [ ] 归档失败时有错误处理和日志记录

## 预计工时

8 小时

## 相关文件

- `src/db.ts`（数据库 Schema 定义）
- `src/services/wordService.ts`（可能需要添加归档服务）
- `src/utils/dataIntegrity.ts`（数据完整性相关）

## 依赖关系

- **建议执行顺序**：第 4 个执行（在 TICKET-009 之后）
- **依赖说明**：归档功能需要稳定的迁移机制支持，建议在数据迁移系统完善后再实现归档

## 架构师备注

**优先级说明**：

- 当前为 P2，因为：
  1. 用户无直接感知
  2. 主要影响长期用户（20-30%）
  3. 当前数据量可能还未达到性能瓶颈

**何时提升优先级**：

- 如果 reviewLogs 表超过 10 万条记录
- 如果用户反馈应用启动变慢
- 如果 IndexedDB 存储接近上限

**技术债务**：

- 此功能是预防性优化，避免未来性能问题
- 建议在数据量达到 5 万条之前完成

---

**创建者**：高级架构师  
**审核状态**：⏳ 待审核
