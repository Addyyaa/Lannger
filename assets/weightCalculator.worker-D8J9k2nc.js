(function(){"use strict";function l(i){const{timesSeen:s,timesCorrect:t,correctStreak:n,wrongStreak:e,repetitions:a,averageResponseTime:c,fastResponseCount:o,slowResponseCount:u}=i;if(s===0)return 0;const f=t/s,g=n*.1,x=e*.15,T=Math.min(a*.1,.3);let r=0;if(s>0){const p=(o||0)/s,F=(u||0)/s;if(r=p*.15,r-=F*.1,c!==void 0)if(c<=3e3)r+=.1;else if(c>=1e4)r-=.1;else{const y=1-(c-3e3)/7e3;r+=y*.1}}let h=f*.5+g-x+T+r;return e>=3&&(h*=.5),Math.max(0,Math.min(1,h))}function d(i){const{averageResponseTime:s,fastResponseCount:t,slowResponseCount:n,timesSeen:e}=i;if(e===0||s===void 0)return .5;const a=3e3,c=1e4;if(s>=c)return 1;if(s<=a)return .2;const o=(s-a)/(c-a);if(e>0){const u=(t||0)/e;if((n||0)/e>.5)return Math.min(1,o+.3);if(u>.5)return Math.max(.1,o-.2)}return Math.max(.1,Math.min(1,o))}function w(i){const{difficulty:s,timesSeen:t,timesCorrect:n}=i;let a=(s??3)/5;if(t>0){const c=1-n/t;a+=c*.3}return Math.min(1,a)}function S(i){const{nextReviewAt:s}=i;if(!s)return 1;const t=Date.now(),e=new Date(s).getTime()-t;if(e<=0)return 1;const a=1440*60*1e3,c=7*a;return e<=a?1:e<=c?.5+.5*(c-e)/(c-a):.1}function m(i){const{nextReviewAt:s}=i;if(!s)return!0;const t=Date.now();return new Date(s).getTime()<=t}function R(i,s){const t=[];let n=0;const e=l(i);if(s==="review"){const o=(1-e)*(1-e)*.6;n+=o,t.push(`掌握程度: ${e.toFixed(2)} (权重: ${o.toFixed(2)})`);const u=S(i);n+=u*.3,t.push(`紧急程度: ${u.toFixed(2)}`),m(i)&&(n+=.2,t.push("已到期"))}else{const o=(1-e)*.4;n+=o,t.push(`掌握程度: ${e.toFixed(2)} (权重: ${o.toFixed(2)})`)}const a=w(i)*.2;n+=a,t.push(`难度权重: ${a.toFixed(2)}`);const c=d(i)*.15;if(n+=c,i.averageResponseTime!==void 0){const o=(i.averageResponseTime/1e3).toFixed(1);t.push(`答题速度: ${o}秒 (权重: ${c.toFixed(2)})`)}if(i.wrongStreak>0){const o=Math.min(i.wrongStreak*.1,.3);n+=o,t.push(`连续答错 ${i.wrongStreak} 次`)}if(i.timesSeen===0&&s!=="review"&&(n+=.2,t.push("新单词")),s==="flashcard")e<.5&&(n+=.15,t.push("闪卡模式：掌握程度低"));else if(s==="review")e<.3?(n+=.25,t.push("复习模式：掌握度很低")):e<.5&&(n+=.15,t.push("复习模式：掌握度较低"));else if(s==="test"){if(e>=.2&&e<=.8){const u=(1-Math.abs(e-.5)*2)*.2;n+=u,t.push(`测试模式：中等掌握程度 (${e.toFixed(2)}, 权重: ${u.toFixed(2)})`)}if(e<.3){const o=(.3-e)*.3;n+=o,t.push(`测试模式：掌握程度低 (${e.toFixed(2)}, 权重: ${o.toFixed(2)})`)}if(e>=.7&&e<=.9){const o=(.9-e)*.1;n+=o,t.push(`测试模式：掌握程度较高 (${e.toFixed(2)}, 权重: ${o.toFixed(2)})`)}i.difficulty&&i.difficulty>=4&&(n+=.1,t.push("测试模式：高难度")),i.wrongStreak>=2&&(n+=.15,t.push(`测试模式：连续答错 ${i.wrongStreak} 次`))}return{wordId:i.wordId,weight:Math.max(0,n),reasons:t}}self.addEventListener("message",i=>{const{type:s,data:t}=i.data;if(s==="calculateWeights"){const{progresses:n,mode:e}=t,a=n.map(o=>R(o,e));a.sort((o,u)=>u.weight-o.weight);const c={type:"weightsCalculated",data:{weights:a}};self.postMessage(c)}})})();
